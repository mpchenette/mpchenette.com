name: Deploy to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_CONTAINER_APP_NAME: mpchenette-webapp
  ACR_NAME: mpchenettecr
  RESOURCE_GROUP: rg-mpchenette-com

jobs:
  terraform:
    name: Terraform
    runs-on: ubuntu-latest
    environment: production

    outputs:
      acr_login_server: ${{ steps.terraform_output.outputs.acr_login_server }}
      container_app_name: ${{ steps.terraform_output.outputs.container_app_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Terraform Init
        run: terraform init
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Plan
        run: terraform plan -out=tfplan
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Get Terraform Outputs
        id: terraform_output
        run: |
          echo "acr_login_server=$(terraform output -raw container_registry_login_server)" >> $GITHUB_OUTPUT
          echo "container_app_name=$(terraform output -raw container_app_name)" >> $GITHUB_OUTPUT

  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: terraform
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to Azure Container Registry
        run: |
          az acr login --name ${{ env.ACR_NAME }}

      - name: Build and push Docker image
        run: |
          docker build -t ${{ needs.terraform.outputs.acr_login_server }}/hello-world-app:${{ github.sha }} .
          docker tag ${{ needs.terraform.outputs.acr_login_server }}/hello-world-app:${{ github.sha }} ${{ needs.terraform.outputs.acr_login_server }}/hello-world-app:latest
          docker push ${{ needs.terraform.outputs.acr_login_server }}/hello-world-app:${{ github.sha }}
          docker push ${{ needs.terraform.outputs.acr_login_server }}/hello-world-app:latest

      - name: Update Container App with new image
        run: |
          az containerapp update \
            --name ${{ needs.terraform.outputs.container_app_name }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ needs.terraform.outputs.acr_login_server }}/hello-world-app:${{ github.sha }}

      - name: Deployment Summary
        run: |
          echo "## Deployment Successful! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ needs.terraform.outputs.acr_login_server }}/hello-world-app:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Container App**: \`${{ needs.terraform.outputs.container_app_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://mpchenette.com" >> $GITHUB_STEP_SUMMARY
